import{B as t,s as d}from"./index-quXyQak6.js";import{B as b,M as S,p as n}from"./modal-Cd9qhBfX.js";import{I as C,s as g,u as h}from"./input-DuvYxsRA.js";import{L as u}from"./link-xBH1X7Er.js";class m extends t{constructor({text:e,from:s,datetime:a,status:i}){const c=d.getUser("user")?.login===s?"name-from":"name-to";super({tag:"div",className:`msg-wrapper ${c}`});const r=new t({tag:"div",className:"msg-container card"}),l=new t({tag:"div",className:"msg-container-header"}),M=new t({tag:"div",className:"msg-text",textContent:`${e}`}),U=new t({tag:"div",className:"msg-date",textContent:`${this.setDate(a)}`}),v=d.getUser("user")?.login===s&&i.isDelivered?"Delivered":"",w=new t({tag:"div",className:"msg-status",textContent:`${v}`}),f=d.getUser("user")?.login===s?"You":s,x=new t({tag:"div",className:`msg-name ${c}`,textContent:`${f}`});l.appendChildren([x,U]),r.appendChildren([l,M,w]),this.appendChildren([r])}setDate=e=>{const s=Intl.DateTimeFormat().resolvedOptions().timeZone,a=new Date(e);return new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:s}).format(a)}}class N extends t{constructor(e){super({tag:"form",className:"message-form"}),this.onSubmit=e,this.node.action="",this.inputMessage=new C({type:"text",className:"form-control",placeholder:"Input yor message...",disabled:!0,onInput:this.changeStatusBtn}),this.btnMessage=new b({type:"submit",className:"btn btn-success disabled",textContent:"Enter"}),this.appendChildren([this.inputMessage,this.btnMessage]),this.addListener("submit",s=>{s.preventDefault();const a=this.inputMessage.getValue();this.onSubmit?.(a)})}inputMessage;btnMessage;changeInputStatus=()=>{this.inputMessage.removeAttribute("disabled")};resetInputMessage=()=>{this.inputMessage.setValue("")};changeStatusBtn=e=>{this.btnMessage.toggleClass("disabled",!e)}}class y extends b{constructor(){super({type:"button",className:"btn btn-sm btn-outline-danger",textContent:"LOGOUT",onClick:()=>{d.deleteData("user"),window.location.href="/",window.history.pushState({},"","/")}})}}class I extends t{user;nameApp=new t({tag:"span",className:"app-title",textContent:"Fun Chat"});btnLogout=new y;constructor(){super({tag:"header",className:"header card"}),this.user=new t({tag:"span",className:"user-title",textContent:`You: ${d.getUser("user")?.login}`}),this.appendChildren([this.nameApp,this.user,this.btnLogout])}}class A extends t{constructor(){const e=new u({className:"author-link",textContent:"YuliyaVoronovich",href:"https://github.com/yuliyavoronovich",target:"_blank"}),s=new u({className:"author",href:"https://rs.school/courses/javascript-mentoring-program",target:"_blank"});s.setHTML("<img class='logo-img' src='./public/img/rs_school_js.svg'>");const a=new t({tag:"div",textContent:"2024"});super({tag:"footer",className:"header card"}),this.appendChildren([e,a,s])}}class H extends t{label;countMsg;currentUser;constructor(e,s,a,i){super({tag:"li",className:"user-item"}),this.currentUser={login:e,isLogined:s};const c=a||"",r=s?"-active":"-no-active";this.countMsg=new t({tag:"span",className:"badge text-bg-danger",textContent:`${c}`}),this.label=new t({tag:"div",className:`user-label status status${r}`,textContent:`${e}`}),this.label.appendChildren([this.countMsg]),i&&this.addListener("click",()=>{i(this.currentUser)}),this.appendChildren([this.label])}}class F{sendMsg(e,s){g.sendMsg("222",e,s).catch(()=>{})}getHistoryMsg(e){g.getHistoryMsg("222",e).catch(()=>{})}}const p=new F;class R extends t{currentUser=d.getUser("user")?.login;isSelectedUser=!1;selectedUser="";userItems=[];header=new I;footer=new A;main=new t({tag:"main",className:"main"});search;aside=new t({tag:"aside",className:"aside card"});usersWrapper=new t({tag:"ul",className:"users-link"});chat=new t({tag:"div",className:"chat card"});chatHeader=new t({tag:"div",className:"chat-header"});chatHeaderStatus=new t({tag:"span",className:"status-in-chat"});chatFooter=new t({tag:"div",className:"chat-footer"});messageForm;userMessages=[];countUnReadMessages=[];chatMainPlaceholder=new t({tag:"div",className:"chat-main-placeholder",textContent:"Select a user to send a message..."});chatMain=new t({tag:"div",className:"chat-main"});isStartChat=!1;usersActive=[];usersInActive=[];modal=new S;constructor(){super({tag:"div",className:"chat-wrapper"}),this.search=new C({type:"text",className:"form-control",placeholder:"Search...",onInput:this.searchUser}),this.messageForm=new N(this.getTextMessage),this.chatFooter.appendChildren([this.messageForm]),this.chatHeader.appendChildren([this.chatHeaderStatus]),this.chatMain.appendChildren([this.chatMainPlaceholder]),this.chat.appendChildren([this.chatHeader,this.chatMain,this.chatFooter]),this.aside.appendChildren([this.search,this.usersWrapper]),this.main.appendChildren([this.aside,this.chat]),this.appendChildren([this.header,this.main,this.footer,this.modal]),h.reLogin(),h.allActiveUsers(),h.allInActiveUsers(),this.subscribesUsers(),this.subscribesMessages(),n.subscribe("error",e=>{console.log(e),this.modal.alertMess(e.error,"danger")}),n.subscribe("connection",e=>{console.log(e),this.modal.closeModal()})}subscribesUsers=()=>{n.subscribe("usersActive",e=>{this.usersActive=[],e.users.forEach(s=>{s.login!==this.currentUser&&(this.usersActive.push(s),this.getHistoryFromUser(s.login))}),this.showUsers(this.usersActive)}),n.subscribe("usersInActive",e=>{this.usersInActive=[],e.users.forEach(s=>{this.usersInActive.push(s),this.getHistoryFromUser(s.login)}),this.showUsers(this.usersInActive)}),n.subscribe("userExternalLogin",e=>{this.usersWrapper.destroyChildren(),h.allActiveUsers(),h.allInActiveUsers(),this.changeStatusOfSelectedUser(e)}),n.subscribe("userExternalLogout",e=>{this.usersWrapper.destroyChildren(),h.allActiveUsers(),h.allInActiveUsers(),this.changeStatusOfSelectedUser(e)})};subscribesMessages=()=>{n.subscribe("messageReceived",e=>{const{text:s,to:a,from:i,datetime:c,status:r}=e;if(this.currentUser===i||this.currentUser===a&&this.selectedUser===i){const l=new m({text:s,from:i,to:a,datetime:c,status:{isDelivered:r.isDelivered,isEdited:r.isEdited,isReaded:r.isReaded}});this.isStartChat||(this.chatMainPlaceholder.addClass("hide"),this.isStartChat=!0),this.chatMain.appendChildren([l])}else this.getHistoryFromUser(i)}),n.subscribe("messageHistory",e=>{this.isSelectedUser&&e.messages.length>0?(this.chatMain.destroyChildren(),this.userMessages=e.messages.map(s=>new m({text:s.text,from:s.from,datetime:s.datetime,status:s.status})),this.chatMain.appendChildren([...this.userMessages])):(console.log(this.countUnReadMessages),this.countUnReadMessages.push(e.messages.filter(s=>s.to===this.currentUser).filter(s=>!s.status.isReaded).length),this.usersWrapper.destroyChildren(),this.showUsers([...this.usersActive,...this.usersInActive]))})};showUsers=e=>{this.userItems=e.map((s,a)=>new H(s.login,s.isLogined,this.countUnReadMessages[a],this.getUser)),this.usersWrapper.appendChildren([...this.userItems])};searchUser=e=>{const s=[...this.usersActive,...this.usersInActive].filter(a=>a.login.toLowerCase().includes(e.toLowerCase()));this.usersWrapper.destroyChildren(),this.showUsers(s)};getUser=e=>{this.isSelectedUser=!0,this.selectedUser=e.login;const s=e.isLogined?"online":"offline";this.chatHeaderStatus.toggleClass("active",e.isLogined),this.chatHeaderStatus.setTextContent(`${s}`),this.chatHeader.setTextContent(`${e.login}`),this.chatMainPlaceholder.setTextContent("Write your first message..."),this.chatHeader.appendChildren([this.chatHeaderStatus]),this.messageForm.changeInputStatus(),this.getHistoryFromUser(e.login)};changeStatusOfSelectedUser=e=>{if(this.isSelectedUser){const s=e.isLogined?"online":"offline";this.chatHeaderStatus.toggleClass("active",e.isLogined),this.chatHeaderStatus.setTextContent(`${s}`)}};getTextMessage=e=>{this.isStartChat||(this.chatMainPlaceholder.addClass("hide"),this.isStartChat=!0),p.sendMsg(e,this.selectedUser),this.messageForm.resetInputMessage(),this.messageForm.changeStatusBtn("")};getHistoryFromUser=e=>{p.getHistoryMsg(e)}}export{R as ChatPage};
