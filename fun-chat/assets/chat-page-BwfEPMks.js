import{B as i,s as d}from"./index-B5cEB_Ph.js";import{B as M,M as E,p as r}from"./modal-CFApMAl2.js";import{I as w,s as l,u as g}from"./input-DosantFG.js";import{L as b}from"./link-DCluJllF.js";class y extends i{statusMsg;textMsg;currentTextMsg;currentSender;currentStatus;statusEdit="";container=new i({tag:"div",className:"msg-container card"});constructor({id:e,text:t,from:s,datetime:a,status:n,onContext:o,onClick:c}){const u=d.getUser("user")?.login===s?"name-from":"name-to";super({tag:"div",className:`msg-wrapper ${u}`}),this.setAttribute("id",`${e}`),this.currentTextMsg=t,this.currentSender=s,this.currentStatus={isDelivered:n.isDelivered,isReaded:n.isReaded,isEdited:n.isEdited};const C=new i({tag:"div",className:"msg-container-header"});this.textMsg=new i({tag:"div",className:"msg-text",textContent:`${this.currentTextMsg}`});const f=new i({tag:"div",className:"msg-date",textContent:`${this.setDate(a)}`}),v=d.getUser("user")?.login===s?this.getStatus(n):"";this.statusMsg=new i({tag:"div",className:"msg-status",textContent:`${v}`});const U=d.getUser("user")?.login===s?"You":s,S=new i({tag:"div",className:`msg-name ${u}`,textContent:`${U}`});C.appendChildren([S,f]),this.container.appendChildren([C,this.textMsg,this.statusMsg]),this.appendChildren([this.container]),o&&this.container.addListener("contextmenu",N=>{N.preventDefault(),o(this,e,s)}),c&&this.container.addListener("click",()=>{c()})}setDate=e=>{const t=Intl.DateTimeFormat().resolvedOptions().timeZone,s=new Date(e);return new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:t}).format(s)};get text(){return this.currentTextMsg}get sender(){return this.currentSender}updateText=e=>{this.textMsg.destroy(),this.textMsg=new i({tag:"div",className:"msg-text",textContent:`${e}`}),this.currentTextMsg=e,this.container.appendChildren([this.textMsg]),this.appendChildren([this.container])};updateStatus=e=>{this.statusMsg.destroy(),this.statusMsg=new i({tag:"div",className:"msg-status",textContent:`${this.getStatus(e)}`}),this.container.appendChildren([this.statusMsg]),this.appendChildren([this.container])};getStatus=({isDelivered:e,isEdited:t,isReaded:s})=>{let a="";return s&&d.getUser("user")?.login===this.currentSender?(a="Readed",this.currentStatus.isReaded=!0):e&&d.getUser("user")?.login===this.currentSender&&(a="Delivered",this.currentStatus.isDelivered=!0),t&&(this.statusEdit=" (Edited)"),console.log(`${a}${this.statusEdit}`),`${a}${this.statusEdit}`}}class L extends i{constructor(e){super({tag:"form",className:"message-form"}),this.onSubmit=e,this.node.action="",this.inputMessage=new w({type:"text",className:"form-control message-form-input",placeholder:"Input yor message...",disabled:!0,onInput:this.changeStatusBtn}),this.btnMessage=new M({type:"submit",className:"btn btn-success disabled",textContent:"Enter"}),this.appendChildren([this.inputMessage,this.btnMessage]),this.addListener("submit",t=>{t.preventDefault();const s=this.inputMessage.getValue();s&&this.onSubmit?.(this.idMsg,s,this.isEdit)})}inputMessage;isEdit=!1;idMsg="";btnMessage;set editForm(e){this.isEdit=e}set IdMsg(e){this.idMsg=e}changeInputStatus=()=>{this.inputMessage.removeAttribute("disabled")};resetInputMessage=()=>{this.inputMessage.setValue("")};changeStatusBtn=e=>{this.btnMessage.toggleClass("disabled",!e.trim())};setValueTextMsg=e=>{this.inputMessage.setValue(e)};setInputColor=()=>{this.inputMessage.addClass("edit")};removeInputColor=()=>{this.inputMessage.removeClass("edit")}}class A extends M{constructor(){super({type:"button",className:"btn btn-sm btn-outline-danger",textContent:"LOGOUT",onClick:()=>{d.deleteData("user"),window.location.href="",window.history.pushState({},"","")}})}}class I extends i{user;nameApp=new i({tag:"span",className:"app-title",textContent:"Fun Chat"});btnLogout=new A;about=new M({type:"button",className:"btn btn-success about-btn",textContent:"About",onClick:()=>{window.location.href="#about"}});constructor(){super({tag:"header",className:"header card"}),this.user=new i({tag:"span",className:"user-title",textContent:`You: ${d.getUser("user")?.login}`}),this.appendChildren([this.nameApp,this.user,this.about,this.btnLogout])}}class F extends i{constructor(){const e=new b({className:"author-link",textContent:"YuliyaVoronovich",href:"https://github.com/yuliyavoronovich",target:"_blank"}),t=new b({className:"author",href:"https://rs.school/courses/javascript-mentoring-program",target:"_blank"});t.setHTML("<img class='logo-img' src='./img/rs_school_js.svg'>");const s=new i({tag:"div",textContent:"2024"});super({tag:"footer",className:"header card"}),this.appendChildren([e,s,t])}}class T extends i{label;countMsg;currentUser;constructor(e,t,s,a){super({tag:"li",className:"user-item"}),this.currentUser={login:e,isLogined:t};const n=s||"",o=t?"-active":"-no-active";this.countMsg=new i({tag:"span",className:"badge text-bg-danger",textContent:`${n}`}),this.label=new i({tag:"div",className:`user-label status status${o}`,textContent:`${e}`}),this.label.appendChildren([this.countMsg]),a&&this.addListener("click",()=>{a(this.currentUser)}),this.appendChildren([this.label])}get user(){return this.currentUser}set countUnReadMsg(e){this.countMsg.setTextContent(e)}}const m="222";class k{sendMsg(e,t){l.sendMsg(m,e,t).catch(()=>{})}editMsg(e,t){l.editMsg(m,e,t).catch(()=>{})}getHistoryMsg(e){l.getHistoryMsg(m,e).catch(()=>{})}deleteMsg(e){l.deleteMsg(m,e).catch(()=>{})}readMsg(e){l.readMsg(m,e).catch(()=>{})}}const p=new k;class x extends i{constructor(e,t,s,a){super({tag:"div",className:"context-menu card"});const n=new M({type:"button",className:"context-menu-link",textContent:"Edit",onClick:()=>{s(e,t)}}),o=new M({type:"button",className:"context-menu-link",textContent:"Delete",onClick:()=>{a(e)}});this.appendChildren([n,o])}}const R=40;class P extends i{currentUser=d.getUser("user")?.login;isSelectedUser=!1;selectedUser="";userItems=[];header=new I;footer=new F;main=new i({tag:"main",className:"main"});search;aside=new i({tag:"aside",className:"aside card"});usersWrapper=new i({tag:"ul",className:"users-link"});chat=new i({tag:"div",className:"chat card"});chatHeader=new i({tag:"div",className:"chat-header"});chatHeaderStatus=new i({tag:"span",className:"status-in-chat"});chatFooter=new i({tag:"div",className:"chat-footer"});messageForm;userMessages=[];countUnReadMessages=[];chatMainPlaceholder=new i({tag:"div",className:"chat-main-placeholder",textContent:"Select a user to send a message..."});chatMain=new i({tag:"div",className:"chat-main custom-scrolbar"});isStartChat=!1;usersActive=[];usersInActive=[];modal=new E;newContext;breakLine;isBreakLine=!1;constructor(){super({tag:"div",className:"chat-wrapper"}),this.search=new w({type:"text",className:"form-control",placeholder:"Search...",onInput:this.searchUser}),this.messageForm=new L(this.sendMessage),this.breakLine=new i({tag:"div",className:"break-line"}),this.chatFooter.appendChildren([this.messageForm]),this.chatHeader.appendChildren([this.chatHeaderStatus]),this.chatMain.appendChildren([this.chatMainPlaceholder]),this.chatMain.addListener("click",this.clickChatMain),this.chatMain.addListener("wheel",this.clickChatMain),this.chat.appendChildren([this.chatHeader,this.chatMain,this.chatFooter]),this.aside.appendChildren([this.search,this.usersWrapper]),this.main.appendChildren([this.aside,this.chat]),this.appendChildren([this.header,this.main,this.footer,this.modal]),this.newContext=new x("0","",this.editMsg,this.deleteMsg),g.reLogin(),g.allActiveUsers(),g.allInActiveUsers(),this.subscribesUsers(),this.subscribesMessages(),r.subscribe("error",e=>{this.modal.alertMess(e.error,"danger")}),r.subscribe("connection",()=>{this.modal.closeModal()})}subscribesUsers=()=>{r.subscribe("usersActive",e=>{this.usersActive=[],e.users.forEach(t=>{t.login!==this.currentUser&&(this.usersActive.push(t),this.getHistoryFromUser(t.login))}),this.showUsers(this.usersActive)}),r.subscribe("usersInActive",e=>{this.usersInActive=[],e.users.forEach(t=>{this.usersInActive.push(t),this.getHistoryFromUser(t.login)}),this.showUsers(this.usersInActive)}),r.subscribe("userExternalLogin",e=>{this.updateUsersAfterExternalLogin(e)}),r.subscribe("userExternalLogout",e=>{this.updateUsersAfterExternalLogin(e)})};subscribesMessages=()=>{r.subscribe("messageReceived",e=>{const{to:t,from:s}=e;if(this.currentUser===s||this.currentUser===t&&this.selectedUser===s){const a=this.addNewMessage(e);this.isStartChat||(this.chatMainPlaceholder.destroy(),this.isStartChat=!0),a&&(this.userMessages.push(a),this.chatMain.appendChildren([a])),this.chatMain.setScrollTop()}else this.getHistoryFromUser(s)}),r.subscribe("messageHistory",e=>{console.log(e),this.isSelectedUser?(this.chatMain.destroyChildren(),e.messages.length>0?(this.userMessages=e.messages.map(t=>this.addNewMessage(t)),this.chatMain.appendChildren([...this.userMessages]),this.chatMain.setScrollTop()):(this.chatMainPlaceholder.removeClass("hide"),this.chatMainPlaceholder.setTextContent("Start dialog..."),this.chatMain.appendChildren([this.chatMainPlaceholder]))):(this.countUnReadMessages.push(e.messages.filter(t=>t.to===this.currentUser).filter(t=>!t.status.isReaded).length),this.usersWrapper.destroyChildren(),this.showUsers([...this.usersActive,...this.usersInActive]))}),r.subscribe("messageDeliver",e=>{this.userMessages.forEach(t=>{t.getAttribute("id")===e.message.id&&t.updateStatus({isDelivered:e.message.isDelivered,isEdited:t.currentStatus.isEdited,isReaded:t.currentStatus.isReaded})})}),r.subscribe("messageRead",e=>{this.userMessages.forEach(t=>{t&&t.getAttribute("id")===e.message.id&&t.updateStatus({isDelivered:t.currentStatus.isDelivered,isEdited:t.currentStatus.isEdited,isReaded:e.message.isReaded})})}),r.subscribe("messageEdit",e=>{this.userMessages.forEach(t=>{t.getAttribute("id")===e.message.id&&(t.updateText(e.message.text),t.updateStatus({isDelivered:t.currentStatus.isDelivered,isEdited:e.message.isEdited,isReaded:t.currentStatus.isReaded}))})}),r.subscribe("messageDelete",e=>{this.userMessages.forEach(t=>{t.getAttribute("id")===e.message.id&&(t.destroy(),delete this.userMessages[this.userMessages.indexOf(t)],this.newContext.destroy())})})};updateUsersAfterExternalLogin=e=>{this.usersWrapper.destroyChildren(),g.allActiveUsers(),g.allInActiveUsers(),this.changeStatusOfSelectedUser(e)};showUsers=e=>{this.userItems=e.map((t,s)=>new T(t.login,t.isLogined,this.countUnReadMessages[s],this.getUser)),this.usersWrapper.appendChildren([...this.userItems])};searchUser=e=>{const t=[...this.usersActive,...this.usersInActive].filter(s=>s.login.toLowerCase().includes(e.toLowerCase()));this.usersWrapper.destroyChildren(),this.showUsers(t)};getUser=e=>{this.isSelectedUser=!0,this.selectedUser=e.login;const t=e.isLogined?"online":"offline";this.chatHeaderStatus.toggleClass("active",e.isLogined),this.chatHeaderStatus.setTextContent(`${t}`),this.chatHeader.setTextContent(`${e.login}`),this.chatMainPlaceholder.setTextContent("Write your first message..."),this.chatHeader.appendChildren([this.chatHeaderStatus]),this.messageForm.changeInputStatus(),this.getHistoryFromUser(e.login)};changeStatusOfSelectedUser=e=>{if(this.isSelectedUser){const t=e.isLogined?"online":"offline";this.chatHeaderStatus.toggleClass("active",e.isLogined),this.chatHeaderStatus.setTextContent(`${t}`)}};addNewMessage=e=>{const{id:t,text:s,to:a,from:n,datetime:o,status:c}=e,u=new y({id:t,text:s,from:n,to:a,datetime:o,status:{isDelivered:c.isDelivered,isEdited:c.isEdited,isReaded:c.isReaded},onContext:this.contextMenuMsg,onClick:this.destroyMenuMsg});return!e.status.isReaded&&!this.isBreakLine&&this.currentUser===a&&(this.breakLine=new i({tag:"div",className:"break-line show"}),u.prepend(this.breakLine),this.isBreakLine=!0),u};sendMessage=(e,t,s)=>{this.isStartChat||(this.chatMainPlaceholder.destroy(),this.isStartChat=!0),s?(p.editMsg(e,t),this.messageForm.removeInputColor()):(p.sendMsg(t,this.selectedUser),this.sendReadMessage()),this.messageForm.resetInputMessage(),this.messageForm.changeStatusBtn("")};getHistoryFromUser=e=>{p.getHistoryMsg(e)};contextMenuMsg=(e,t,s)=>{if(s===this.currentUser){this.newContext.destroy();const a=new x(t,e.text,this.editMsg,this.deleteMsg);this.newContext=a,this.chatMain.appendChildren([this.newContext]);const n=Number(e.getNodeProperty("offsetTop"));this.newContext.setStyle("top",`${n+R}px`)}};sendReadMessage=()=>{this.userMessages.forEach(e=>{const t=e.getAttribute("id");t&&e.sender===this.selectedUser&&p.readMsg(t)}),this.userItems.forEach(e=>{if(e.user.login===this.selectedUser){const t=e;t.countUnReadMsg=""}}),this.breakLine.destroy(),this.isBreakLine=!1};clickChatMain=()=>{this.destroyMenuMsg(),this.sendReadMessage()};destroyMenuMsg=()=>{this.newContext.destroy()};editMsg=(e,t)=>{this.messageForm.editForm=!0,this.messageForm.IdMsg=e,this.messageForm.setValueTextMsg(t),this.messageForm.setInputColor(),this.messageForm.changeStatusBtn("true")};deleteMsg=e=>{p.deleteMsg(e)}}export{P as ChatPage};
